<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Studio Pro V12 - Chroma & Upload Background</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <style>
        :root { --accent: #00d4ff; --bg: #0a0a0a; --fx: #ff0050; --chroma: #00ff00; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 320px; background: #151515; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; z-index: 10; }
        .main-stage { flex-grow: 1; display: flex; background: #000; justify-content: center; align-items: center; position: relative; }
        #canvas-container { width: 90%; aspect-ratio: 16 / 9; position: relative; background: #111; border: 2px solid #333; }
        canvas { width: 100%; height: 100%; cursor: move; }
        .card { background: #222; padding: 10px; border-radius: 8px; border: 1px solid #333; margin-bottom: 5px; }
        h3 { font-size: 11px; margin: 0 0 8px 0; color: var(--accent); text-transform: uppercase; border-bottom: 1px solid #333; }
        .card.fx h3 { color: var(--fx); }
        input, button, select { width: 100%; background: #000; border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; font-size: 11px; margin-bottom: 4px; }
        .btn-start { background: #2ed573 !important; color: #000; font-weight: bold; cursor: pointer; }
        .btn-fx { background: var(--fx) !important; color: white; font-weight: bold; cursor: pointer; }
        label { font-size: 9px; color: #888; display: block; margin-top: 2px; }
        .layer-item { background: #111; padding: 8px; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid #444; }
        .layer-item.on { border-left-color: #2ed573; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="card">
        <h3>1. Camera Standard (C)</h3>
        <button id="loadBtn" class="btn-start">START DEVICE</button>
        <button id="toggleAI" class="btn-ai">AI CUT-OUT: OFF</button>
        <label>Scalare</label>
        <input type="range" id="camSize" min="10" max="250" value="80">
        <label>Luminozitate</label>
        <input type="range" id="camBright" min="0" max="200" value="100">
    </div>

    <div class="card fx" style="border-color: var(--fx)">
        <h3>2. Shatter FX (ENTER)</h3>
        <button id="toggleFX" class="btn-fx">FX: OFF (ENTER)</button>
        <label>Scalare FX</label>
        <input type="range" id="fxSize" min="10" max="250" value="80">
        <label>Intensitate Tremurat</label>
        <input type="range" id="fxPower" min="0" max="100" value="20">
        <label>Transparenta</label>
        <input type="range" id="fxAlpha" min="0" max="100" value="100">
    </div>

    <div class="card">
        <h3>3. Fundal Studio</h3>
        <select id="bgSourceType">
            <option value="none">Negru</option>
            <option value="green">Verde (Chroma)</option>
            <option value="photo">Foto Upload</option>
            <option value="video">Video Upload</option>
        </select>
        
        <div id="bgUploadArea">
            <input type="file" id="bgPhotoInp" accept="image/*" style="display:none">
            <input type="file" id="bgVideoInp" accept="video/*" style="display:none">
        </div>
        <p style="font-size: 9px; color: #666;">DacÄƒ alegi Foto/Video, butonul de upload apare automat.</p>
    </div>

    <div id="layerContainer">
        <h3>4. Layere (Taste 1-5)</h3>
    </div>
</div>

<div class="main-stage">
    <div id="canvas-container">
        <canvas id="c_out"></canvas>
    </div>
</div>

<video id="v_raw" autoplay muted playsinline style="display:none"></video>
<video id="v_bg" loop muted playsinline style="display:none"></video>
<img id="img_bg" style="display:none">

<script>
    const video = document.getElementById('v_raw');
    const canvas = document.getElementById('c_out');
    const ctx = canvas.getContext('2d');
    const bgVideo = document.getElementById('v_bg');
    const bgImg = document.getElementById('img_bg');
    
    let aiActive = false, fxActive = false, selectedObj = null;
    const renderW = 1920, renderH = 1080;

    const camState = { id: 'cam1', x: 480, y: 540, s: 80, b: 100, visible: true };
    const fxState = { id: 'cam2', x: 1440, y: 540, s: 80, p: 20, a: 1, visible: false };
    const layers = [];

    // Init Layere
    for (let i = 1; i <= 5; i++) {
        layers[i] = { id: 'L'+i, visible: false, x: 960, y: 800, s: 30, el: null };
        const div = document.createElement('div');
        div.className = 'layer-item'; div.id = `ui-${i}`;
        div.innerHTML = `
            <strong>Layer ${i}</strong> 
            <input type="file" id="f-${i}" accept="image/*,video/*">
            <label>Scalare Layer</label>
            <input type="range" id="s-${i}" min="5" max="250" value="30">
        `;
        document.getElementById('layerContainer').appendChild(div);

        document.getElementById(`f-${i}`).onchange = (e) => {
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            if(file.type.startsWith('video')) {
                const v = document.createElement('video'); v.src = url; v.loop=true; v.muted=true; v.play(); layers[i].el = v;
            } else {
                const img = new Image(); img.src = url; layers[i].el = img;
            }
        };
        document.getElementById(`s-${i}`).oninput = (e) => layers[i].s = e.target.value;
    }

    // --- DRAG LOGIC ---
    canvas.onmousedown = (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = (e.clientX - rect.left) * (renderW / rect.width);
        const my = (e.clientY - rect.top) * (renderH / rect.height);
        selectedObj = null;
        for (let i = 5; i >= 1; i--) if (layers[i].visible && layers[i].el && isHit(mx, my, layers[i])) { selectedObj = layers[i]; return; }
        if (fxActive && isHit(mx, my, fxState)) { selectedObj = fxState; return; }
        if (camState.visible && isHit(mx, my, camState)) { selectedObj = camState; return; }
    };
    function isHit(mx, my, obj) {
        const w = renderW * (obj.s / 100);
        const h = w * 0.56; 
        return Math.abs(mx - obj.x) < w/2 && Math.abs(my - obj.y) < h/2;
    }
    window.onmousemove = (e) => {
        if (selectedObj) {
            const rect = canvas.getBoundingClientRect();
            selectedObj.x = (e.clientX - rect.left) * (renderW / rect.width);
            selectedObj.y = (e.clientY - rect.top) * (renderH / rect.height);
        }
    };
    window.onmouseup = () => selectedObj = null;

    // --- RENDER ---
    const selfie = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(onResults);

    function onResults(results) {
        canvas.width = renderW; canvas.height = renderH;
        ctx.clearRect(0, 0, renderW, renderH);
        
        // LOGICA FUNDAL
        const st = document.getElementById('bgSourceType').value;
        if(st === 'green') {
            ctx.fillStyle = "#00ff00"; ctx.fillRect(0,0,renderW,renderH);
        } else if(st === 'photo' && bgImg.src) {
            ctx.drawImage(bgImg, 0, 0, renderW, renderH);
        } else if(st === 'video' && bgVideo.readyState >= 2) {
            ctx.drawImage(bgVideo, 0, 0, renderW, renderH);
        } else {
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,renderW,renderH);
        }

        // Camere
        if (camState.visible) drawCam(results, camState, false);
        if (fxActive) drawCam(results, fxState, true);

        // Layere
        layers.forEach(l => {
            if(l.visible && l.el) {
                const w = renderW * (l.s/100);
                const h = (l.el.videoHeight || l.el.height) / (l.el.videoWidth || l.el.width) * w;
                ctx.drawImage(l.el, l.x - w/2, l.y - h/2, w, h);
            }
        });
    }

    function drawCam(results, state, isFX) {
        const w = renderW * (state.s / 100);
        const h = (video.videoHeight / video.videoWidth) * w || w * 0.56;
        let x = state.x - w/2;
        let y = state.y - h/2;
        ctx.save();
        if(isFX) {
            ctx.globalAlpha = state.a;
            x += (Math.random() - 0.5) * state.p;
            y += (Math.random() - 0.5) * state.p;
        }
        ctx.filter = `brightness(${state.b || 100}%)`;
        if (aiActive && results.segmentationMask) {
            const off = document.createElement('canvas'); off.width = renderW; off.height = renderH;
            const oCtx = off.getContext('2d');
            oCtx.drawImage(results.image, x, y, w, h);
            oCtx.globalCompositeOperation = 'destination-in';
            oCtx.drawImage(results.segmentationMask, x, y, w, h);
            ctx.drawImage(off, 0, 0);
        } else {
            ctx.drawImage(video, x, y, w, h);
        }
        ctx.restore();
    }

    async function processLoop() {
        if(video.readyState >= 2) await selfie.send({image: video});
        else onResults({});
        requestAnimationFrame(processLoop);
    }

    // --- UI EVENTS ---
    window.onkeydown = (e) => {
        if(e.key === 'Enter') { e.preventDefault(); fxActive = !fxActive; document.getElementById('toggleFX').innerText = fxActive ? "FX: ON" : "FX: OFF (ENTER)"; }
        if(e.key === 'c' || e.key === 'C') camState.visible = !camState.visible;
        if(e.key >= 1 && e.key <= 5) { layers[e.key].visible = !layers[e.key].visible; document.getElementById(`ui-${e.key}`).classList.toggle('on'); }
    };

    document.getElementById('loadBtn').onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({video: {width: 1280, height: 720}});
        video.srcObject = stream; video.play(); processLoop();
    };

    document.getElementById('toggleAI').onclick = () => {
        aiActive = !aiActive;
        document.getElementById('toggleAI').innerText = aiActive ? "AI: ACTIV" : "AI: OFF";
    };

    // LOGICA FUNDAL SELECTOR
    document.getElementById('bgSourceType').onchange = (e) => {
        const val = e.target.value;
        document.getElementById('bgPhotoInp').style.display = (val === 'photo') ? 'block' : 'none';
        document.getElementById('bgVideoInp').style.display = (val === 'video') ? 'block' : 'none';
    };

    document.getElementById('bgPhotoInp').onchange = (e) => {
        const file = e.target.files[0];
        if(file) bgImg.src = URL.createObjectURL(file);
    };

    document.getElementById('bgVideoInp').onchange = (e) => {
        const file = e.target.files[0];
        if(file) {
            bgVideo.src = URL.createObjectURL(file);
            bgVideo.play();
        }
    };

    // Slidere Camere
    document.getElementById('camSize').oninput = (e) => camState.s = e.target.value;
    document.getElementById('camBright').oninput = (e) => camState.b = e.target.value;
    document.getElementById('fxSize').oninput = (e) => fxState.s = e.target.value;
    document.getElementById('fxPower').oninput = (e) => fxState.p = e.target.value;
    document.getElementById('fxAlpha').oninput = (e) => fxState.a = e.target.value / 100;
</script>
</body>
</html>
